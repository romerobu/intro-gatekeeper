apiVersion: templates.gatekeeper.sh/v1beta1
kind: ConstraintTemplate
metadata:
  name: k8sreplicaset
spec:
  crd:
    spec:
      names:
        kind: K8sReplicaSet
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package k8sreplicaset

        violation[{"msg": msg}] {
          replicaset_name := input.review.object.spec.metadata.name
          ns := input.review.object.spec.metadata.namespace
          deployment_name := data.inventory.namespace[ns]["v1"]["Deployment"][_]["metadata"]["name"]
          contains(replicaset_name, deployment_name)
          msg := sprintf("You have created a Replica Set without a deployment %v", [replicaset_name])
        }          
